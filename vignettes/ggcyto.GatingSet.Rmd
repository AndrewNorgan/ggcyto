---
title: "Visualize GatingSet with ggcyto"
output:
  html_document:
    fig_height: 3
    fig_width: 4
    keep_md: yes
vignette: >    
  %\VignetteEngine{knitr}
  %\VignetteIndexEntry{Visualize GatingSet with ggcyto}        
---

```{r, echo=FALSE}
library(knitr)
opts_chunk$set(message = FALSE, warning = FALSE)
```


```{r echo=FALSE}
library(ggcyto)
dataDir <- system.file("extdata",package="flowWorkspaceData")
gs <- load_gs(list.files(dataDir, pattern = "gs_manual",full = TRUE))
```


```{r}
p <- ggcyto(gs, aes(x = CD4, y = CD8), subset = "CD3+") 
# 2d plot 
p <- p + geom_hex(bins = 64)
p

#use instrument range by overwritting limits setting in the default parameter setting
p + ggcyto_par_set(limits = "instrument")

#manually set limits
myPars <- ggcyto_par_set(limits = list(x = c(0,3.5e3), y = c(-10, 4.1e3)))
p <- p + myPars# or xlim(0,3.5e3) + ylim(-10, 4e3) 
p

# print the default settings
ggcyto_par_default()
# add gate
p + geom_gate("CD4")

# add two gates
p <- p + geom_gate(c("CD4","CD8")) # short for geom_gate("CD8") + geom_gate("CD4")
p

# add stats (for all gate layers by default) and only display marker on axis
p + geom_stats() + labs_cyto("marker")

# add stats just for one specific gate
p + geom_stats("CD4")

# change stats type, background color and position
p + geom_stats("CD4", type = "count", size = 6,  color = "white", fill = "black", adjust = 0.3)
```

```{r error=T}
# 'subset' is abstract without specifiying it
p <- ggcyto(gs, aes(x = CD4, y = CD8)) + geom_hex() + myPars
p
```

```{r}

# it can be instantiated by gate layer
p + geom_gate(c("CD4", "CD8"))

# plot all children of the specified parent and projections
p <- ggcyto(gs, aes(x = 38, y = DR), subset = "CD4") + geom_hex(bins = 64) + geom_gate() + geom_stats()
p

# add gates to the arbitary(non-parent) node
ggcyto(gs, subset = "root", aes(x = CD4, y = CD8)) + geom_hex(bins = 64) + geom_gate("CD4") + myPars

# inverse transform the axis without affecting the data
p + axis_x_inverse_trans() + axis_y_inverse_trans()
#add filter (consistent with `margin` behavior in flowViz)
# ggcyto(gs, aes(x = CD4, y = CD8), subset = "3+", filter = marginalFilter)  + geom_hex(bins = 32, na.rm = T)
```


```{r}
class(p)
# knowing that for 'ggcyto' is the semi-ggplot object since the data slot is NOT fortified to data.frame
# until it is printed/plotted.
# (other than this it is completely ggplot compatible in terms of adding layers and parameters)
class(p$data)

# To return a regular ggplot object
p <- as.ggplot(p)

class(p)
class(p$data)
```




